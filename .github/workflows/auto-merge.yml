---
name: Auto Merge (ready to merge label)

on:  # yamllint disable-line rule:truthy
  pull_request_target:
    types:
      - labeled

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  # see https://www.m3tech.blog/entry/github-auto-merge
  squash-merge:
    if: >
      github.event.label.name == 'ready to merge' &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.state == 'open' &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Create merge approval check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          CHECK_NAME="Merge Approval by Action"
          HEAD_SHA=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json headRefOid --jq '.headRefOid')

          if ! gh api repos/"$REPO"/check-runs -X POST \
            -F name="$CHECK_NAME" \
            -F head_sha="$HEAD_SHA" \
            -F status="completed" \
            -F conclusion="success" 2>&1; then
            echo "::error::Failed to create check run for PR approval"
            exit 1
          fi

          echo "âœ… Created check run: $CHECK_NAME"

      - name: Squash-merge pull request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = pr.number;

            const { data: fresh } = await github.rest.pulls.get({ owner, repo, pull_number: number });

            if (fresh.merged) {
              core.info(`PR #${number} is already merged.`);
              return;
            }

            try {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: number,
                merge_method: 'squash',
                commit_title: fresh.title,
              });
              core.info(`Squash merged PR #${number}.`);
              return;
            } catch (error) {
              core.warning(`Direct merge attempt failed (${error.message}). Trying to enable auto-merge instead.`);
            }

            try {
              await github.graphql(
                `
                  mutation EnableAutoMerge($pullId: ID!, $method: PullRequestMergeMethod!) {
                    enablePullRequestAutoMerge(input: { pullRequestId: $pullId, mergeMethod: $method }) {
                      pullRequest {
                        number
                        autoMergeRequest {
                          enabledAt
                        }
                      }
                    }
                  }
                `,
                { pullId: fresh.node_id, method: 'SQUASH' }
              );
              core.info(`Enabled auto-merge (squash) for PR #${number}; it will merge when branch protections pass.`);
            } catch (error) {
              core.setFailed(`Failed to merge or enable auto-merge for PR #${number}: ${error.message}`);
            }
